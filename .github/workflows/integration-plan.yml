# Badge: Integration: plan
#
# DECISION: Runs `tofu plan` against real provider APIs (no apply).
# Why: Validates provider auth, schema compatibility, and module wiring
#      beyond what mock_provider can catch.
#
# NOTE: Requires HCLOUD_TOKEN secret. Skipped when secrets are unavailable
# (e.g. PRs from forks) to avoid false-red badges.

name: "Integration: plan"

on:
  workflow_dispatch: {}
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  plan:
    name: tofu plan (examples/minimal)
    runs-on: ubuntu-latest

    # WORKAROUND: Secrets are not available to workflows triggered from forks.
    # Skipping keeps the workflow green instead of falsely failing.
    if: ${{ vars.HAS_CLOUD_CREDENTIALS == 'true' }}

    defaults:
      run:
        working-directory: examples/minimal

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: opentofu/setup-opentofu@9d84900f3238fab8cd84ce47d658d25dd008be2f # v1.0.8
        with:
          # SECURITY: Disable wrapper to prevent tofu stdout/stderr from being
          # written to GITHUB_OUTPUT file on disk (could persist sensitive data).
          tofu_wrapper: false

      - name: Cache providers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: examples/minimal/.terraform/providers
          key: ${{ runner.os }}-tofu-${{ hashFiles('.terraform.lock.hcl') }}

      - name: Init
        run: tofu init -backend=false -input=false

      - name: Plan (no apply)
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_domain: "ci.example.com"
          # SECURITY: Force TF_LOG empty to prevent debug-level output from
          # leaking sensitive resource attributes into workflow logs.
          TF_LOG: ""
        run: tofu plan -input=false -no-color 2>&1 | tee plan_output.txt

      - name: Post plan summary
        if: always()
        working-directory: examples/minimal
        run: |
          echo '### Integration: plan (examples/minimal)' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 plan_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Cleanup (always)
        if: always()
        working-directory: examples/minimal
        # SECURITY: plan with -backend=false shouldn't create state,
        # but defense in depth â€” remove any generated files.
        run: |
          find . -name 'terraform.tfstate*' -exec rm -f {} + 2>/dev/null || true
          find . -name '*.tfplan' -exec rm -f {} + 2>/dev/null || true
          rm -rf .terraform/ 2>/dev/null || true
