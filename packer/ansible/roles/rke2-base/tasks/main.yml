---
# Tasks for rke2-base role — system preparation for RKE2 nodes
#
# DECISION: Pre-install packages and configure kernel modules at image build time.
# Why: Every node gets identical baseline. No runtime apt-get calls = faster
#      bootstrap and no dependency on package mirrors during cloud-init.

- name: Install required packages
  ansible.builtin.apt:
    name: "{{ rke2_base_packages }}"
    state: present
    update_cache: true
  retries: 3
  delay: 5

- name: Load kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ rke2_base_kernel_modules }}"

- name: Persist kernel modules across reboots
  ansible.builtin.lineinfile:
    path: /etc/modules-load.d/rke2.conf
    line: "{{ item }}"
    create: true
    mode: "0644"
  loop: "{{ rke2_base_kernel_modules }}"

- name: Apply sysctl settings
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-rke2.conf
    reload: true
  loop: "{{ rke2_base_sysctl | dict2items }}"

- name: Enable and start iscsid
  ansible.builtin.systemd:
    name: iscsid
    enabled: true
    state: started

- name: Create RKE2 config directory
  ansible.builtin.file:
    path: /etc/rancher/rke2
    state: directory
    mode: "0700"

# ──────────────────────────────────────────────────────────────────────────────
# RKE2 binary pre-installation
#
# DECISION: Install RKE2 at image build time, not at boot time.
# Why: Eliminates the curl | sh call and GitHub download (~2-3 min) from the
#      cloud-init critical path. Every node starts with binaries already present.
#      The bootstrap script detects the pre-installed version and skips re-install.
#
# DECISION: Use INSTALL_RKE2_SKIP_START=true during image build.
# Why: The image is a snapshot — there is no cluster token, no config.yaml, and
#      no network to join at build time. Starting rke2-server here would fail.
#      Systemd unit is intentionally NOT enabled; cloud-init bootstrap does that.
#
# NOTE: kubernetes_version="" installs the latest stable release. Using a pinned version
#       is strongly recommended so the image version matches var.kubernetes_version in
#       the Terraform module. Build a new image when upgrading RKE2.
# ──────────────────────────────────────────────────────────────────────────────

- name: Pre-install RKE2 binaries (server + agent)
  ansible.builtin.shell: |
    set -euo pipefail
    {% if kubernetes_version != "" %}
    INSTALL_RKE2_VERSION="{{ kubernetes_version }}" \
    {% endif %}
    INSTALL_RKE2_SKIP_START=true \
    sh -c "$(curl -sfL https://get.rke2.io)"
  args:
    creates: /usr/local/bin/rke2
  retries: 3
  delay: 10

- name: Pre-install RKE2 agent binaries
  ansible.builtin.shell: |
    set -euo pipefail
    {% if kubernetes_version != "" %}
    INSTALL_RKE2_VERSION="{{ kubernetes_version }}" \
    {% endif %}
    INSTALL_RKE2_TYPE=agent \
    INSTALL_RKE2_SKIP_START=true \
    sh -c "$(curl -sfL https://get.rke2.io)"
  args:
    # NOTE: rke2-agent.service appears only after agent install; use as idempotency marker.
    creates: /usr/local/lib/systemd/system/rke2-agent.service
  retries: 3
  delay: 10

- name: Record pre-installed RKE2 version into image metadata file
  # DECISION: Write a version stamp file so the bootstrap script can compare it
  # against var.kubernetes_version at runtime and skip re-install when they match.
  ansible.builtin.shell: |
    /usr/local/bin/rke2 --version | head -1 | awk '{print $3}'
  register: _rke2_installed_version
  changed_when: false

- name: Write RKE2 version stamp file
  ansible.builtin.copy:
    content: "{{ _rke2_installed_version.stdout | trim }}\n"
    dest: /etc/rke2-image-version
    mode: "0444"
